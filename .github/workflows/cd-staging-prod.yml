name: CD - Staging + Production

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_pgsql, mbstring, xml
      
      - name: Install Dependencies
        run: composer install --no-dev --prefer-dist --ignore-platform-reqs --optimize-autoloader
      
      - name: Build Frontend
        run: |
          npm install --legacy-peer-deps
          npm install @popperjs/core --save
          npm run build
      
      - name: Generate Release ID
        run: echo "${{ github.sha }}" > RELEASE_ID
      
      - name: Archive Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: |
            ./*
            !node_modules
            !.git

  deploy_staging:
    needs: build
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/download-artifact@v4
        with: { name: app-build, path: . }
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy Staging
        run: |
          RELEASE=$(cat RELEASE_ID)
          TARGET="/var/www/comprasventas/staging"
          USER="${{ secrets.STAGING_USER }}"
          HOST="${{ secrets.HOST_IP }}"
          
          # 1. Crear directorio del release
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $USER@$HOST "mkdir -p $TARGET/releases/$RELEASE"
          
          # 2. Subir archivos
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" --exclude='.env' ./ $USER@$HOST:$TARGET/releases/$RELEASE
          
          # 3. Configurar y desplegar (AQUÍ ESTÁ LA MAGIA)
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $USER@$HOST "
            # --- CREAR CARPETAS FALTANTES MANUALMENTE ---
            mkdir -p $TARGET/releases/$RELEASE/storage/framework/views
            mkdir -p $TARGET/releases/$RELEASE/storage/framework/cache
            mkdir -p $TARGET/releases/$RELEASE/storage/framework/sessions
            mkdir -p $TARGET/releases/$RELEASE/storage/logs
            mkdir -p $TARGET/releases/$RELEASE/bootstrap/cache
            # --------------------------------------------

            ln -nfs $TARGET/shared/.env $TARGET/releases/$RELEASE/.env
            
            # Ahora sí funcionará el chmod porque las carpetas ya existen
            chmod -R 777 $TARGET/releases/$RELEASE/storage $TARGET/releases/$RELEASE/bootstrap/cache
            
            ln -sfn $TARGET/releases/$RELEASE $TARGET/current
            cd $TARGET/current
            
            # Comandos de Laravel
            php artisan optimize:clear
            php artisan migrate --force
          "

      - name: Health Check
        run: |
           sleep 5
           curl -k "${{ secrets.STAGING_APP_URL }}/api/health" || echo "Health check warning"

  rollback_staging:
    needs: deploy_staging
    if: failure()
    runs-on: ubuntu-latest
    steps:
      # ESTO FALTABA PARA QUE NO DE ERROR 255:
      - name: Setup SSH for Rollback
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
      
      - name: Execute Rollback
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.STAGING_USER }}@${{ secrets.HOST_IP }} "
            TARGET='/var/www/comprasventas/staging'
            PREV=\$(ls -1dt \$TARGET/releases/*/ | sed -n '2p' | tr -d '/')
            if [ -n \"\$PREV\" ]; then
              ln -sfn \$PREV \$TARGET/current
              echo "Rollback exitoso a \$PREV"
            fi
          "

  deploy_production:
    needs: deploy_staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/download-artifact@v4
        with: { name: app-build, path: . }
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy Production
        run: |
          RELEASE=$(cat RELEASE_ID)
          TARGET="/var/www/comprasventas/prod"
          USER="${{ secrets.PROD_USER }}"
          HOST="${{ secrets.HOST_IP }}"
          
          # 1. Crear directorio (Igual que en Staging)
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $USER@$HOST "mkdir -p $TARGET/releases/$RELEASE"
          
          # 2. Subir archivos (Igual que en Staging)
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" --exclude='.env' ./ $USER@$HOST:$TARGET/releases/$RELEASE
          
          # 3. Configurar (Igual que en Staging + mkdirs de seguridad)
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $USER@$HOST "
            # Crear carpetas críticas
            mkdir -p $TARGET/releases/$RELEASE/storage/framework/views
            mkdir -p $TARGET/releases/$RELEASE/storage/framework/cache
            mkdir -p $TARGET/releases/$RELEASE/storage/framework/sessions
            mkdir -p $TARGET/releases/$RELEASE/storage/logs
            mkdir -p $TARGET/releases/$RELEASE/bootstrap/cache

            ln -nfs $TARGET/shared/.env $TARGET/releases/$RELEASE/.env
            
            chmod -R 777 $TARGET/releases/$RELEASE/storage $TARGET/releases/$RELEASE/bootstrap/cache
            
            ln -sfn $TARGET/releases/$RELEASE $TARGET/current
            cd $TARGET/current
            
            php artisan optimize:clear
            php artisan migrate --force
          "

      - name: Health Check
        run: curl -k "${{ secrets.PROD_APP_URL }}/api/health" || echo "Health check warning"